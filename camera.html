<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Truck Check - Camera</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Lao:wght@100..900&family=Sarabun:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <div class="lang-switcher">
                <button class="lang-btn" id="lang-la" onclick="setLanguage('la')">LA</button>
                <button class="lang-btn" id="lang-en" onclick="setLanguage('en')">EN</button>
            </div>
            <h1 data-i18n="title">TMGT LOGISTICS</h1>
            <div class="nav-links">
                <a href="index.html" class="nav-btn" data-i18n="nav_search">SEARCH</a>
                <a href="camera.html" class="nav-btn active" data-i18n="nav_camera">CAMERA</a>
                <a href="sun_paper.html" class="nav-btn" data-i18n="nav_sun_paper">SUN PAPER</a>
            </div>
        </header>

        <main>
            <div class="camera-container">
                <video id="video" autoplay playsinline></video>
                <div class="scan-overlay">
                    <div class="scan-box"></div>
                </div>
            </div>

            <div style="text-align: center;">
                <div id="plateDisplay"
                    style="font-size: 1.5rem; font-weight: 800; margin-bottom: 10px; color: var(--accent);"
                    data-i18n="status_scanning">
                    SCANNING...
                </div>
                <div id="statusIndicator" class="scan-status bg-warning"
                    style="display:inline-block; margin-bottom: 20px;" data-i18n="status_scanning">
                    SCANNING...
                </div>

                <div id="resultCard"
                    style="display:none; background: var(--glass); padding: 20px; border-radius: 16px; margin-bottom: 20px; text-align: left; border-left: 4px solid var(--success);">
                    <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 12px;">CUSTOMER / SHIPMENT
                        TYPE</div>
                    <div id="resCustomer"
                        style="font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; line-height: 1.2;">-</div>
                    <div id="resShipmentType" class="badge-shipment bg-info"
                        style="margin-top: -8px; margin-bottom: 16px;">
                        -</div>

                    <div class="plate-cell">
                        <!-- Truck & Trailer Card (Stacked) -->
                        <div class="chip-group">
                            <span class="status-badge bg-warning badge-stack" style="width: 100%;">
                                <div class="stack-row">
                                    <span class="badge-label" data-i18n="label_truck">Truck</span>
                                    <span class="badge-value" id="resTruck">-</span>
                                </div>
                                <div class="stack-row" id="resTrailerRow">
                                    <span class="badge-label" data-i18n="label_trailer">Trailer</span>
                                    <span class="badge-value" id="resTrailer">-</span>
                                </div>
                            </span>
                        </div>

                        <!-- Truck Size -->
                        <div id="resTruckSizeGroup" class="chip-group">
                            <span class="status-badge bg-warning"><span class="badge-label"
                                    data-i18n="label_tsize">T-Size</span><span id="resTruckSize">-</span></span>
                        </div>

                        <div style="height: 4px;"></div>

                        <!-- Container Card -->
                        <div id="resContainerGroup" class="chip-group">
                            <span class="chip chip-solo bg-success"><span class="badge-label"
                                    data-i18n="label_cont">Cont</span><span id="resContainer">-</span></span>
                        </div>

                        <!-- Container Size -->
                        <div id="resContSizeGroup" class="chip-group">
                            <span class="status-badge bg-success"><span class="badge-label"
                                    data-i18n="label_csize">C-Size</span><span id="resContSize">-</span></span>
                        </div>
                    </div>

                    <div style="margin-top: 16px;">
                        <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 4px;">REMARK</div>
                        <div id="resRemark" style="font-size: 0.9rem; color: var(--warning); font-style: italic;">-
                        </div>
                    </div>
                </div>

                <button id="actionBtn" class="btn-primary" onclick="toggleScan()">STOP SCAN</button>

                <div id="debugView"
                    style="margin-top: 20px; font-size: 0.75rem; color: var(--text-muted); font-family: monospace; white-space: pre-wrap; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: left; display: none;">
                    DEBUG: RAW OCR OUTPUT WILL APPEAR HERE
                </div>
                <button onclick="document.getElementById('debugView').style.display = 'block'"
                    style="background: none; border: none; color: var(--text-muted); font-size: 0.7rem; margin-top: 10px; cursor: pointer;">Show
                    Debug Info</button>
            </div>
        </main>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script type="module" src="db.js"></script>
    <script type="module">
        import tr from './translations.js';

        const currentLang = localStorage.getItem('lang') || 'la';
        window.currentLang = currentLang;

        async function updateUI() {
            const strings = tr[window.currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (!strings[key]) return;

                if (el.tagName === 'INPUT') {
                    el.placeholder = strings[key];
                } else {
                    el.innerText = strings[key];
                }
            });

            // Update active button
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.id === `lang-${window.currentLang}`);
            });

            // Special handling for dynamic camera status if not scanning/matched
            const statusIndicator = document.getElementById('statusIndicator');
            const actionBtn = document.getElementById('actionBtn');
            const plateDisplay = document.getElementById('plateDisplay');

            if (window.scanning) {
                statusIndicator.innerText = strings.status_scanning;
                if (plateDisplay.innerText.includes('SCANNING') || plateDisplay.innerText.includes('FINDING')) {
                    plateDisplay.innerText = strings.status_scanning;
                }
                actionBtn.innerText = window.currentLang === 'la' ? "ຢຸດການສະແກນ" : "STOP SCAN"; // Fallback for action btn
            }
        }

        window.setLanguage = (lang) => {
            window.currentLang = lang;
            localStorage.setItem('lang', lang);
            updateUI();
        };

        document.addEventListener('DOMContentLoaded', updateUI);
        window.updateTranslations = updateUI;
    </script>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const plateDisplay = document.getElementById('plateDisplay');
        const statusIndicator = document.getElementById('statusIndicator');
        const resultCard = document.getElementById('resultCard');
        const actionBtn = document.getElementById('actionBtn');

        let scanning = true;
        let scheduler = null;
        let worker = null;

        async function initCamera() {
            // 1. Start Camera Immediately
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = stream;
            } catch (err) {
                console.error('Camera permission/access error:', err);
                alert('Camera error: ' + err.message);
                return;
            }

            // 2. Initialize Database in background (don't block the camera display)
            try {
                if (!window.truckDB) {
                    await new Promise(resolve => {
                        const check = setInterval(() => {
                            if (window.truckDB) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                        // Timeout after 5 seconds
                        setTimeout(() => {
                            clearInterval(check);
                            resolve();
                        }, 5000);
                    });
                }

                if (window.truckDB) {
                    await window.truckDB.init();
                    // Warm up cache but don't strictly wait for it if it takes too long
                    window.truckDB.getAllBookings().catch(e => console.error("Cache warm-up failed:", e));
                } else {
                    console.error("truckDB failed to load within timeout");
                }

                // 3. Init Tesseract
                // 3. Init Tesseract - Reduced languages to just eng+tha+lao for faster processing
                worker = await Tesseract.createWorker(['eng', 'tha', 'lao']);
                await worker.setParameters({
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-กขคฆงจฉชซฌญฎฏฐฑฒณดตถทธนบปผฝพฟภมยรลวศษสหฬอฮກຂຄງຈສຊຍດຕຖທນບປຜຝພຟມຢຣລວຫອຮ. ',
                    tessedit_pageseg_mode: '11', // Sparse text (PSM 11) is generally faster for plates
                });

                requestAnimationFrame(scanLoop);
            } catch (err) {
                console.error('OCR/DB initialization error:', err);
            }
        }

        async function scanLoop() {
            if (!scanning) return;

            const vw = video.videoWidth;
            const vh = video.videoHeight;
            if (vw === 0) {
                requestAnimationFrame(scanLoop);
                return;
            }

            // Adjusted to 40% to capture dual line plates but focusing on center
            const cropW = vw * 0.92;
            const cropH = vh * 0.40;
            const cropX = (vw - cropW) / 2;
            const cropY = (vh - cropH) / 2;

            // Optimization: Downscale processing canvas for speed (max width 600px)
            const targetWidth = Math.min(600, cropW);
            const scale = targetWidth / cropW;
            canvas.width = targetWidth;
            canvas.height = cropH * scale;

            // Image Pre-processing for better OCR
            ctx.filter = 'grayscale(100%) contrast(150%) brightness(110%)';
            ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, canvas.width, canvas.height);
            ctx.filter = 'none'; // reset for next frame

            const { data: { text } } = await worker.recognize(canvas);

            // Update debug view
            if (text) {
                document.getElementById('debugView').innerText = `DEBUG RAW:\n"${text}"`;
            }

            const plate = cleanupPlate(text);

            if (plate) {
                plateDisplay.innerText = plate;
                checkDatabase(plate);
            } else {
                plateDisplay.innerText = "FINDING PLATE...";
            }

            if (scanning) {
                setTimeout(() => requestAnimationFrame(scanLoop), 200);
            }
        }

        function cleanupPlate(text) {
            if (!text) return null;

            // 1. Clean and split into lines
            let rawLines = text.toUpperCase()
                .replace(/O/g, '0')
                .replace(/[IL|]/g, '1')
                .split('\n');

            const scoredLines = rawLines.map(rawLine => {
                // Keep only allowed chars for counting/processing
                const line = rawLine.replace(/[^A-Z0-9ก-ฮກ-ຮ]/g, '');
                if (line.length < 3) return { line, score: -1 };

                // Count specific character types to filter noise/province names
                const thaiChars = (line.match(/[ก-ฮ]/g) || []).length;
                const engChars = (line.match(/[A-Z]/g) || []).length;
                const laoChars = (line.match(/[ກ-ຮ]/g) || []).length;

                // User restrictions: limit alphas to force focus on "ID" part of plate
                if (thaiChars > 3) return { line, score: -1 }; // e.g. "กรุงเทพมหานคร"
                if (engChars > 2) return { line, score: -1 };  // e.g. "LOGISTICS"
                if (laoChars > 2) return { line, score: -1 };

                let score = 0;
                // Preferred length for a plate ID is 4-8 chars
                if (line.length >= 4 && line.length <= 8) score += 10;
                if (/[0-9]/.test(line)) score += 5;
                if (thaiChars > 0 || engChars > 0 || laoChars > 0) score += 5;

                // Bonus for standard patterns
                if (/^[0-9]?[ก-ฮ]{2}[0-9]{1,4}$/.test(line)) score += 20; // Thai Main
                if (/^[ກ-ຮ]{2}[0-9]{4}$/.test(line)) score += 20;        // Lao Main

                return { line, score };
            }).filter(item => item.score > 0);

            // Sort by score descending
            scoredLines.sort((a, b) => b.score - a.score);

            if (scoredLines.length > 0) {
                return scoredLines[0].line;
            }

            return null;
        }

        async function checkDatabase(plate) {
            // Use strict exact matching for the camera to prevent "near misses" or partial hits
            const found = await truckDB.findExactBooking(plate);

            const trObj = (await import('./translations.js')).default;
            const strings = trObj[window.currentLang || 'la'];

            if (found) {
                stopScanning();
                showResult(found);
            } else {
                statusIndicator.innerText = strings.status_scanning;
                statusIndicator.className = "scan-status bg-warning";
                resultCard.style.display = 'none';
            }
        }

        async function showResult(data) {
            const trObj = (await import('./translations.js')).default;
            const strings = trObj[window.currentLang || 'la'];

            statusIndicator.innerText = strings.status_match;
            statusIndicator.className = "scan-status bg-success";

            const clean = (val) => (!val || val.toString().toLowerCase() === 'nan' || val === '-') ? null : val;

            const truck = clean(data.truck) || '-';
            const trailer = clean(data.trailer);
            const truckSize = clean(data.truckSize);
            const container = clean(data.container);
            const containerSize = clean(data.containerSize);
            const remark = clean(data.remark);

            document.getElementById('resCustomer').innerText = data.customer || '-';
            document.getElementById('resShipmentType').innerText = data.shipmentType || '-';
            document.getElementById('resTruck').innerText = truck;

            // Trailer
            const trailerRow = document.getElementById('resTrailerRow');
            if (trailer) {
                trailerRow.style.display = 'grid'; // stack-row uses grid
                document.getElementById('resTrailer').innerText = trailer;
            } else {
                trailerRow.style.display = 'none';
            }

            // Truck Size
            const sizeGroup = document.getElementById('resTruckSizeGroup');
            if (truckSize) {
                sizeGroup.style.display = 'flex';
                document.getElementById('resTruckSize').innerText = truckSize;
            } else {
                sizeGroup.style.display = 'none';
            }

            // Container
            const contGroup = document.getElementById('resContainerGroup');
            if (container) {
                contGroup.style.display = 'flex';
                document.getElementById('resContainer').innerText = container;
            } else {
                contGroup.style.display = 'none';
            }

            // Container Size
            const cSizeGroup = document.getElementById('resContSizeGroup');
            if (containerSize) {
                cSizeGroup.style.display = 'flex';
                document.getElementById('resContSize').innerText = containerSize;
            } else {
                cSizeGroup.style.display = 'none';
            }

            document.getElementById('resRemark').innerText = remark || '-';

            resultCard.style.display = 'block';

            actionBtn.innerText = window.currentLang === 'la' ? "ເລີ່ມສະແກນໃໝ່" : "RESUME SCAN";
            actionBtn.className = "btn-primary";
        }

        function stopScanning() {
            scanning = false;
        }

        async function toggleScan() {
            const trObj = (await import('./translations.js')).default;
            const strings = trObj[window.currentLang || 'la'];

            if (scanning) {
                scanning = false;
                statusIndicator.innerText = window.currentLang === 'la' ? "ຢຸດແລ້ວ" : "STOPPED";
                statusIndicator.className = "scan-status bg-danger";
                actionBtn.innerText = window.currentLang === 'la' ? "ເລີ່ມສະແກນໃໝ່" : "RESUME SCAN";
            } else {
                scanning = true;
                statusIndicator.innerText = strings.status_scanning;
                statusIndicator.className = "scan-status bg-warning";
                actionBtn.innerText = window.currentLang === 'la' ? "ຢຸດການສະແກນ" : "STOP SCAN";
                resultCard.style.display = 'none';
                requestAnimationFrame(scanLoop);
            }
        }

        initCamera();
    </script>
</body>

</html>